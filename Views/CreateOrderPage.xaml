<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BanHangVip.ViewModels"
             xmlns:model="clr-namespace:BanHangVip.Models"
             x:Class="BanHangVip.Views.CreateOrderPage"
             Title="New Order"
             BackgroundColor="#ECEFF1">

    <Grid ColumnDefinitions="{OnIdiom Phone='*', Tablet='2*, 1*'}"
          RowDefinitions="{OnIdiom Phone='*, Auto', Tablet='*'}">

        <!-- LEFT/TOP: Catalog -->
        <Grid Grid.Row="0" Grid.Column="0" RowDefinitions="Auto, *">
            <Label Text="Select Seafood" FontSize="18" Padding="15" FontAttributes="Bold" TextColor="#37474F"/>

            <CollectionView Grid.Row="1" ItemsSource="{Binding MenuItems}" Margin="10">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="{OnIdiom Phone=2, Tablet=3}" VerticalItemSpacing="10" HorizontalItemSpacing="10"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:SeafoodItem">
                        <Border StrokeShape="RoundRectangle 15" StrokeThickness="0" BackgroundColor="White" HeightRequest="120">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CreateOrderViewModel}}, Path=SelectItemCommand}" CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>
                            <Grid RowDefinitions="*, Auto">
                                <!-- Colored Header simulating image bg -->
                                <BoxView Color="{Binding ColorHex}" Opacity="0.2" Grid.RowSpan="2"/>
                                <Label Text="{Binding Name}" 
                                       VerticalOptions="Center" 
                                       HorizontalOptions="Center" 
                                       FontSize="20" 
                                       FontAttributes="Bold"
                                       TextColor="#333"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Overlay for Weight Input -->
            <Grid Grid.RowSpan="2" BackgroundColor="#aa000000" IsVisible="{Binding SelectedItem, Converter={x:StaticResource IsNotNullConverter}}">
                <Border BackgroundColor="White" VerticalOptions="Center" HorizontalOptions="Center" WidthRequest="320" StrokeShape="RoundRectangle 20" Padding="20">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="{Binding SelectedItem.Name}" HorizontalOptions="Center" FontSize="22" FontAttributes="Bold"/>

                        <Border Stroke="#006064" StrokeThickness="2" Padding="10" BackgroundColor="#FAFAFA">
                            <Label Text="{Binding WeightInput, StringFormat='{0} kg'}" FontSize="32" HorizontalOptions="Center" TextColor="#006064" FontAttributes="Bold"/>
                        </Border>

                        <!-- Custom Numpad -->
                        <Grid ColumnDefinitions="*,*,*" RowDefinitions="60,60,60,60" ColumnSpacing="10" RowSpacing="10">
                            <Button Text="1" Grid.Row="0" Grid.Column="0" Command="{Binding AddDigitCommand}" CommandParameter="1" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="2" Grid.Row="0" Grid.Column="1" Command="{Binding AddDigitCommand}" CommandParameter="2" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="3" Grid.Row="0" Grid.Column="2" Command="{Binding AddDigitCommand}" CommandParameter="3" BackgroundColor="#EEE" TextColor="Black"/>

                            <Button Text="4" Grid.Row="1" Grid.Column="0" Command="{Binding AddDigitCommand}" CommandParameter="4" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="5" Grid.Row="1" Grid.Column="1" Command="{Binding AddDigitCommand}" CommandParameter="5" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="6" Grid.Row="1" Grid.Column="2" Command="{Binding AddDigitCommand}" CommandParameter="6" BackgroundColor="#EEE" TextColor="Black"/>

                            <Button Text="7" Grid.Row="2" Grid.Column="0" Command="{Binding AddDigitCommand}" CommandParameter="7" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="8" Grid.Row="2" Grid.Column="1" Command="{Binding AddDigitCommand}" CommandParameter="8" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="9" Grid.Row="2" Grid.Column="2" Command="{Binding AddDigitCommand}" CommandParameter="9" BackgroundColor="#EEE" TextColor="Black"/>

                            <Button Text="." Grid.Row="3" Grid.Column="0" Command="{Binding AddDigitCommand}" CommandParameter="." BackgroundColor="#EEE" TextColor="Black" FontAttributes="Bold"/>
                            <Button Text="0" Grid.Row="3" Grid.Column="1" Command="{Binding AddDigitCommand}" CommandParameter="0" BackgroundColor="#EEE" TextColor="Black"/>
                            <Button Text="⌫" Grid.Row="3" Grid.Column="2" Command="{Binding AddDigitCommand}" CommandParameter="DEL" BackgroundColor="#FFEBEE" TextColor="Red"/>
                        </Grid>

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Text="Cancel" BackgroundColor="#CCC" TextColor="Black" Command="{Binding SelectItemCommand}" CommandParameter="{x:Null}"/>
                            <Button Text="ADD ITEM" BackgroundColor="#006064" TextColor="White" Command="{Binding AddToCartCommand}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </Grid>

        <!-- RIGHT/BOTTOM: Basket -->
        <Grid Grid.Row="{OnIdiom Phone=1, Tablet=0}" Grid.Column="{OnIdiom Phone=0, Tablet=1}" BackgroundColor="White" RowDefinitions="Auto, *, Auto">
            <Label Text="Current Order" FontSize="18" FontAttributes="Bold" Padding="15" BackgroundColor="#FFF"/>

            <CollectionView Grid.Row="1" ItemsSource="{Binding CurrentOrder.Items}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:OrderItem">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Delete" BackgroundColor="Red" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CreateOrderViewModel}}, Path=RemoveItemCommand}" CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Grid ColumnDefinitions="*, Auto" Padding="15,10">
                                <VerticalStackLayout>
                                    <Label Text="{Binding Item.Name}" FontSize="16"/>
                                    <Label Text="{Binding DisplayWeight}" FontSize="14" TextColor="#777"/>
                                </VerticalStackLayout>
                                <Label Grid.Column="1" Text="×" VerticalOptions="Center" TextColor="#CCC" FontSize="20"/>
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid Grid.Row="2" Padding="20" BackgroundColor="#FAFAFA" RowDefinitions="Auto, Auto">
                <Grid ColumnDefinitions="*, Auto" Margin="0,0,0,10">
                    <Label Text="Total Weight:" TextColor="#555"/>
                    <Label Text="{Binding CurrentOrder.TotalWeight, StringFormat='{0:F2} kg'}" FontAttributes="Bold" Grid.Column="1" TextColor="#333"/>
                </Grid>
                <Button Grid.Row="1" Text="SUBMIT ORDER" BackgroundColor="#006064" HeightRequest="50" CornerRadius="25" FontAttributes="Bold" Command="{Binding SubmitOrderCommand}"/>
            </Grid>
        </Grid>
    </Grid>

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:IsNotNullConverter xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit" x:Key="IsNotNullConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
</ContentPage>